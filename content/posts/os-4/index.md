+++
date = '2025-05-22T17:04:32+08:00'
draft = true
title = '第四章 设备管理'
summary = "操作系统笔记"
tags = ["笔记", "OS", "操作系统"]
categories = ["StudyBase"]
seriesOpened = true
series = ["笔记-操作系统"]
series_order = 4
+++

{{< katex >}} 

{{<alert "edit">}}
本文介绍了 os 对外围设备（IO 相关设备、磁盘、虚拟设备等）的管理。
{{</alert>}}

## Part1 设备管理概述

### 1.1 I/O 设备

I/O设备，也称为输入输出设备、外围设备或外部设备，是计算机系统与外部世界（如用户、其他计算机或设备）进行信息交换或存储的桥梁。

I/O操作指的是**内存和外设之间的信息传送**操作，这些操作不仅影响计算机系统的通用性和可扩展性，也是决定系统综合处理能力（短板效应）和性价比的重要因素。

#### 分类

从信息传输的角度来看，I/O设备可以分为

1. **输入设备**：负责将外界信息输入到计算机中，例如**键盘、鼠标、扫描仪**等；
2. **输出设备**：将计算结果输出到外部，如**显示器、打印机**等；
3. **输入输出设备**：既能输入也能输出信息，典型代表有**磁盘驱动器、网卡**等。

如果从交互功能的角度分类，I/O设备可以分为

1. **人机交互设备**：用于用户与计算机之间的交互通信，如**鼠标、键盘、显示器**等；
2. **存储设备**：用于存储大量信息并支持快速检索，如**磁盘驱动器、光盘驱动器**等；
3. **机机通信设备**：用于计算机之间的通信，例如**网卡、调制解调器**等。

从设备管理的视角出发，I/O设备又可以分为

1. 字符设备：以字符为单位进行信息交换，如**鼠标、显示器**等；
2. 块设备：以固定大小的数据块为单位进行信息交换，典型如**磁盘**，块是存储介质上连续信息组成的一个区域；
3. 网络设备：用于计算机间的通信，可以被抽象为传送字符流的字符设备，也可以被抽象为传送连续小块数据的块设备。

### 1.2 设备管理概述

#### 设备管理的目标

1. 并行：解决设备和CPU速度不匹配的问题，使主机和设备能够充分并行工作，提高设备的使用效率；
2. 抽象：屏蔽设备的物理细节和操作过程，**通过配置驱动程序为上层提供统一的接口**。操作系统可以将设备抽象为**裸设备**，也可以进一步抽象为**设备文件**，方便用户和应用程序进行统一管理和访问。

#### 设备管理的功能

- **设备中断处理**：当外设完成数据传输或需要与主机通信时，会通过中断机制通知CPU，操作系统需要及时响应和处理中断，保证数据的正确传递和系统的高效运行。

- **缓冲区管理**：协调主机和外设之间速度的差异。通过设置缓冲区，可以实现数据的暂存和批量传送，减少CPU等待时间，提高整体吞吐率。

- **设备的分配和回收**：os 需要根据进程的请求，合理分配有限的设备资源，并在使用结束后及时回收，避免资源浪费和冲突。

- **设备驱动调度**：协调多个进程对同一设备的访问请求，按照一定的策略进行排队和调度，权衡**公平性/高效性**

- **虚拟设备的实现**：通过软件手段将物理设备抽象为多个虚拟设备，或者将多个物理设备整合为一个虚拟设备，为多用户、多任务环境下的设备共享和隔离提供了有力支持，也是云计算和虚拟化技术（如，VPS）的基础之一。

#### 设备管理的实现层次

最底层是I/O硬件，包括

1. **I/O 设备及其接口线路**负责实现主机与外设之间的物理连接和信号传递；
2. **控制部件**则负责解释主机发出的命令、管理数据传输过程，并处理设备状态的反馈；
3. **通道**是一种专门用于管理复杂 I/O 操作的硬件部件，能够在主机和多个外设之间实现高效的数据传输和任务调度。

在硬件之上，是I/O软件层。

1. **系统I/O软件**：由操作系统内核负责，主要实现设备驱动、缓冲管理、中断处理、设备分配等功能，为上层应用提供统一的接口和抽象。

2. **用户空间I/O软件**：运行在用户进程中，通常以**库函数或 API** 的形式出现，负责发起I/O请求、处理数据格式转换等。

### 1.3 I/O 控制方式

#### 设备控制的硬件：设备控制器

设备控制器是实现I/O设备模块化和通用性的重要硬件部件。通常，设备的机械部分和电子部分是分开的，电子部分即为设备控制器[^1]。

{{< alert icon="scope" cardColor="#80CDBF" textColor="#000000" >}}

##### COA 复习：设备控制的硬件实现

![](IO_interface.png)

设备控制器位于主机（CPU -> I/O总线）和设备（接口电缆）之间，起到桥梁和协调的作用。它主要由三部分组成：数据缓冲寄存器、状态/控制寄存器，以及地址译码和I/O控制逻辑。

数据缓冲寄存器用于暂存主机和外设之间传输的数据，保证数据能够顺利地在不同速度的主机和设备之间交换。状态/控制寄存器则用来存放设备的当前状态信息和控制命令，主机可以通过这些寄存器了解设备的工作状态或向设备发送控制指令。地址译码和I/O控制逻辑负责识别主机发来的地址和控制信号，判断主机要访问的是哪个设备、进行什么操作，并协调数据和命令的传递。

在设备控制器的另一侧，连接着外设接口控制逻辑，这部分负责与具体的外部设备进行通信，实现数据、状态和控制信号的最终交互。

整个设备控制器通过数据线、地址线和控制线与主机相连，通过接口电缆与外设相连，实现了主机和外设之间的数据和控制信息的双向传递。

{{</alert>}}

操作系统和主机系统并不直接与设备本身交互，而是通过设备控制器来实现对设备的具体控制。设备控制器作为**CPU与设备之间的桥梁**，负责：

1. 接收和识别CPU或通道发来的命令
2. 实现主机与设备之间的数据交换
3. 发现和记录设备及自身的状态信息
4. 在连接多台设备时，识别设备地址。

[^1]: 这个部件的名字有点多：设备适配器、I/O控制器、I/O控制接口、I/O模块或I/O接口，题目都有可能出现……

在I/O控制方式上，操作系统主要采用三种典型方式：轮询方式、中断方式和DMA方式。

#### I/O控制的不同方式

![](diff_Ways.png)

##### I/O 控制的轮询方式

轮询方式下，处理器向控制器发送I/O命令后，会不断轮询设备状态，只有设备就绪时才进行数据交换，等待I/O操作完成后，处理器才可以继续其他操作。这种方式会导致CPU资源的浪费。

##### I/O 控制的中断方式


中断方式则更为高效，处理器向控制器发出 I/O 命令后可以继续执行其他任务（若进程支持异步I/O，后续
指令仍可是该进程中的指令；否则，进程被挂起[^2]，处理器执行其他工作），等设备准备好后由控制器发出中断信号，CPU 响应中断并进行数据交换和中断处理。

[^2]: os 课件原话，但是捏，我认为这里更准确的说是进入了阻塞态（block/sleep）而不是挂起（swap/suspend）

##### I/O 控制的 DMA 方式

DMA（`Direct Memory Access`, 直接存储器访问）方式则进一步解放了CPU。DMA 模块能够在不需要 CPU 干预的情况下，直接控制**主存和设备控制器之间**的数据传送。处理器只需向 DMA 模块发出 I/O 命令，DMA模块负责整个数据传送过程，传送结束后再通过中断通知CPU。

DMA方式中还存在“周期窃取”机制——DMA的工作自然需要占用总线，这不是反而耽误了CPU？其实，DMA并不是一直拥有总线的控制权，而是在CPU和内存之间的数据传输过程中，在CPU不使用总线的某些时刻，悄悄插入自己的一些传输周期，把数据搬运到内存或从内存取出。这个过程就像“趁空隙偷偷用一下”，所以叫“周期窃取”。DMA 和 CPU 可以同时通过总线访问内存，CPU会在某些主存周期内让出总线控制权给DMA，虽然数据传送过程是不连续和不规则的，但对 CPU 与主存的数据交换影响较小，**因为CPU大部分时间与 Cache 进行数据交换，直接访问内存的频率较低**。

{{< alert icon="scope" cardColor="#80CDBF" textColor="#000000" >}}

##### 复习 COA: DMA模块的硬件实现

![](DMA_hardware.png)

DMA控制器的核心由四个部分组成：数据计数器、数据寄存器、地址寄存器和控制逻辑。

1. 数据计数器用于记录还需要传输的数据字节数，每完成一次数据传输，计数器就会自动递减，直到所有数据传输完毕。
2. 数据寄存器用来暂存正在传输的数据，实现数据在线路上的缓冲和中转。
3. 地址寄存器则保存当前要访问的内存地址，每传输一个数据，地址寄存器会自动加一，指向下一个内存单元。
4. 控制逻辑部分负责整个DMA传输过程的协调和管理，包括响应CPU发出的DMA请求、发出DMA确认信号、处理中断、读写控制等。

DMA控制器通过数据线和地址线与主存和外设进行数据和地址的交换，同时通过多根控制线与CPU进行通信，实现DMA请求、确认、中断和读写等操作。

{{</alert>}}

#### I/O 通道

IO通道/通道控制器/IO处理器，是实现复杂I/O任务自动化和高效并行处理的重要硬件部件。与普通的设备控制器相比，I/O通道具备更强的独立处理能力，能够完成逻辑上独立的I/O任务。

现代大型计算机系统通常采用四级连接结构：处理器、通道、控制器和设备。通道位于处理器和设备控制器之间，可以同时管理和调度多台同类或不同类的设备。

在 I/O 通道的工作模式下，处理器不再直接执行具体的 I/O 指令，而是

1. 将 I/O 操作的详细步骤编写成"通道程序"，并将通道程序的起始地址（CAW，通道地址字）写入指定寄存器，启动相应的通道；
2. 通道随后根据 CAW 从主存中读取通道程序，自动控制I/O设备完成数据传输和相关操作，而 CPU 则可以继续执行其他任务，实现高度的并行；
3. 当 I/O 操作完成后，I/O 通道会向CPU发出中断信号，通知主机 I/O 任务已结束。CPU 响应中断后，通过读取通道程序状态字（CSW）获取通道的执行情况，并据此进行后续的 I/O 处理。

### 1.4 总线

在计算机系统中，由于I/O设备的种类繁多，速度差异极大，数据传送率可能相差几个数量级，单靠简单的点对点连接[^3]无法实现高效的数据交换。总线是一种共享通信通道，是为了解决 I/O 设备与CPU、主存、各设备 I/O 之间速度不匹配的问题。

[^3]: 指的是在早期或非常简单的计算机系统中，每一个 I/O 设备都通过一组专用的信号线直接与CPU或主存相连

#### 单总线结构

![](single_bus.png)

最基础的单总线结构模型将CPU、主存和所有I/O模块都连接到同一条总线上。

1. 优点：是简单、易于扩展，适合设备数量较少的场景。
2. 缺点：但当系统中设备数量增多时，共用总线会带来带宽压力，慢速外设占用总线时间过不同 I/O 设备的数据速率差异过大

#### 三级总线模型

![](3-lv_bus.png)

为进一步提升系统性能，现代计算机常采用三级总线模型。主存和Cache通过主存总线连接，主存总线与扩展总线之间通过**扩展总线借接口**实现数据交换，扩展总线则连接各类I/O设备。

1. 优点：主存与I/O之间的数据传送和处理器的内存活动可以分离，支持更多的I/O设备。
2. 缺点：当**不同 I/O 设备的数据速率差异过大**时，三级总线的效率还是会受到影响。

#### 南桥北桥

![](bridges.png)

针对不同速率设备的需求，南桥（低速）与北桥（高速）结构应运而生。北桥芯片通过处理器总线、存储总线、PCI 总线连接 CPU、主存和高速 I/O 设备（如显卡、PCI设备），南桥芯片则通过 E(ISA) 总线等连接低速I/O设备。这样可以根据设备的数据速率分层管理，既保证了高速设备的带宽需求，又兼顾了低速设备的接入。

#### 基于通道的服务器总线模型

在服务器和高端系统中，还常见基于通道的总线模型。这种结构支持CPU、主存和多个I/O通道之间的数据传送，同时支持I/O通道与I/O控制器、I/O控制器与设备之间的高效数据交换。通过多级总线和通道的协同，系统能够灵活应对不同类型和速率的设备接入，最大化资源利用率和系统吞吐能力。


